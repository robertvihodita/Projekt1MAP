<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${appointment.id == null ? 'Add New Appointment' : 'Edit Appointment'}"></title>
    <style>
        .error-message { color: red; font-size: 0.9em; margin-left: 10px; }
        .global-error { color: darkred; font-weight: bold; margin-bottom: 15px; padding: 10px; border: 1px solid darkred; background-color: #ffe0e0; }
    </style>
</head>
<body>

<h1 th:text="${appointment.id == null ? 'Add New Appointment' : 'Edit Appointment (' + appointment.id + ')'}"></h1>

<form th:action="@{/appointments}" th:object="${appointment}" method="post">
    <div th:if="${globalError}" class="global-error">
        <p th:text="${globalError}"></p>
    </div>
    <div th:if="${#fields.hasGlobalErrors()}" class="global-error">
        <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
    </div>

    <input type="hidden" th:field="*{id}" th:if="${appointment.id != null}" />

    <div>
        <label for="department">Department:</label>
        <select id="department" th:field="*{department}">
            <option th:value="null" disabled selected>-- Select Department --</option>
            <option th:each="dept : ${departments}"
                    th:value="${dept.id}"
                    th:text="${dept.name}"
                    th:selected="${appointment.department != null and appointment.department.id == dept.id}">
            </option>
        </select>
        <span th:if="${#fields.hasErrors('department')}" th:errors="*{department}" class="error-message"></span>
    </div>
    <br/>

    <div>
        <label for="patient">Patient:</label>
        <select id="patient" th:field="*{patient}">
            <option th:value="null" disabled selected>-- Select Patient --</option>
            <option th:each="pat : ${patients}"
                    th:value="${pat.id}"
                    th:text="${pat.name}"
                    th:selected="${appointment.patient != null and appointment.patient.id == pat.id}">
            </option>
        </select>
        <span th:if="${#fields.hasErrors('patient')}" th:errors="*{patient}" class="error-message"></span>
    </div>
    <br/>

    <div>
        <label for="room">Room:</label>
        <select id="room" th:field="*{room}">
            <option th:value="null" selected>-- Select Room (Optional) --</option>
            <option th:each="r : ${rooms}"
                    th:value="${r.id}"
                    th:text="${r.number + ' (' + r.hospital.name + ') - Cap: ' + r.capacity}"
                    th:selected="${appointment.room != null and appointment.room.id == r.id}">
            </option>
        </select>
        <span th:if="${#fields.hasErrors('room')}" th:errors="*{room}" class="error-message"></span>
    </div>
    <br/>

    <div>
        <label for="admissionDate">Admission Date:</label>
        <input type="datetime-local" id="admissionDate" th:field="*{admissionDate}" />
        <span th:if="${#fields.hasErrors('admissionDate')}" th:errors="*{admissionDate}" class="error-message"></span>
    </div>
    <br/>

    <div>
        <label for="status">Status:</label>
        <select id="status" th:field="*{status}">
            <option th:each="stat : ${statuses}"
                    th:value="${stat}"
                    th:text="${stat}">
            </option>
        </select>
        <span th:if="${#fields.hasErrors('status')}" th:errors="*{status}" class="error-message"></span>
    </div>
    <br/>

    <div>
        <button type="submit" th:text="${appointment.id == null ? 'Add Appointment' : 'Update Appointment'}"></button>
    </div>
</form>

<br/>
<a th:href="@{/appointments}">Back to List</a>
</body>
</html>